#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

console.log('🚀 Installing Next.js Auto-Restart Setup...\n');

// Check if we're in a Next.js project
if (!fs.existsSync('package.json')) {
    console.error('❌ Error: No package.json found. Please run this in your Next.js project root.');
    process.exit(1);
}

const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));

if (!packageJson.dependencies?.next && !packageJson.devDependencies?.next) {
    console.error('❌ Error: This doesn\'t appear to be a Next.js project.');
    process.exit(1);
}

// Read the template script
let smartDevScript;
try {
    smartDevScript = fs.readFileSync(path.join(__dirname, 'smart-dev-template.sh'), 'utf8');
} catch (error) {
    console.error('❌ Error: Could not find smart-dev-template.sh');
    console.error('Make sure this script is in the same directory as the template.');
    process.exit(1);
}

// Update package.json
const originalBuild = packageJson.scripts?.build || 'next build';
const projectName = path.basename(process.cwd());

packageJson.scripts = {
    ...packageJson.scripts,
    'dev-smart': './smart-dev.sh',
    'build': `${originalBuild.replace(' && touch /tmp/', ' && touch /tmp/').split(' && touch')[0]} && touch /tmp/${projectName}-build-signal`
};

// Write files
try {
    fs.writeFileSync('smart-dev.sh', smartDevScript);
    fs.chmodSync('smart-dev.sh', '755');
    console.log('✅ Created smart-dev.sh');

    fs.writeFileSync('package.json', JSON.stringify(packageJson, null, 2));
    console.log('✅ Updated package.json');

    // Create README section
    const readmeAddition = `
## 🔄 Auto-Restart Dev Server

This project includes an auto-restart feature for the dev server:

### Quick Start
\`\`\`bash
# Terminal 1: Start smart dev server
npm run dev-smart

# Terminal 2: Build (auto-restarts Terminal 1)
npm run build
\`\`\`

### How it works
- \`npm run dev-smart\` starts a dev server that watches for build signals
- \`npm run build\` triggers an automatic restart of the dev server
- No more manual Ctrl+C → \`npm run dev\` after builds!

*Generated by [next-auto-restart](https://github.com/your-username/next-auto-restart)*
`;

    console.log('\n🎉 Setup complete!\n');
    console.log('📖 Usage:');
    console.log('   Terminal 1: npm run dev-smart');
    console.log('   Terminal 2: npm run build');
    console.log('\n💡 Add this to your README.md:');
    console.log(readmeAddition);

} catch (error) {
    console.error('❌ Error:', error.message);
    process.exit(1);
} 